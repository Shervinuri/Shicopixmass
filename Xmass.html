<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>SHŒûN‚Ñ¢ Imagine Pro - Santa Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --gold: #FFD700;
      --dark-gold: #DAA520;
      --christmas-red: #DC143C;
      --christmas-green: #0B6623;
      --luxury-black: #0A0A0A;
      --frost-white: #F0F8FF;
      --gradient-primary: linear-gradient(135deg, #FFD700, #DC143C, #0B6623);
      --gradient-secondary: linear-gradient(135deg, #DAA520, #FF1744, #1B5E20);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #0f0f1e 100%);
      color: #d1d5db;
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
    }
    /* Scrollbars */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(11, 102, 35, 0.1); }
    ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #FFD700, #DC143C); border-radius: 10px; box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
    ::-webkit-scrollbar-thumb:hover { background: linear-gradient(180deg, #DAA520, #FF1744); box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }

    /* Glass */
    .glass { background: rgba(255,255,255,0.08); backdrop-filter: blur(10px); border: none; opacity: 0.85; }
    .glass-border { border: 1px solid rgba(255, 215, 0, 0.3); }

    /* Animations & helpers */
    @keyframes luxuryGlow {
      0%,100% { box-shadow: 0 0 20px rgba(255,215,0,0.3), 0 0 40px rgba(220,20,60,0.2), inset 0 0 20px rgba(255,215,0,0.1); }
      50% { box-shadow: 0 0 30px rgba(255,215,0,0.5), 0 0 60px rgba(220,20,60,0.3), inset 0 0 30px rgba(255,215,0,0.2); }
    }
    @keyframes twinkling { 0%,100% {opacity:0.3;} 50% {opacity:1;} }
    @keyframes gradient-move { 0% {background-position:0% 50%;} 50% {background-position:100% 50%;} 100% {background-position:0% 50%;} }
    @keyframes christmas-shake {0%{transform:rotate(0);}25%{transform:rotate(-5deg);}50%{transform:rotate(5deg);}75%{transform:rotate(-5deg);}100%{transform:rotate(0);}}
    @keyframes slideInFromTop { to { opacity: 1; transform: translateY(0);} }
    .font-brand { font-family: 'Orbitron', sans-serif; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 30; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .hidden { display: none !important; }

    /* Header */
    .header-container { position: fixed; top: 0; left: 0; right: 0; z-index: 20; display: flex; flex-direction: column; align-items: center; padding-top: 1rem; }
    .arched-header { border-color: rgba(255, 215, 0, 0.4); animation: luxuryGlow 3s ease-in-out infinite; width: 95%; max-width: 400px; height: 48px; border-top-left-radius: 50% 20px; border-top-right-radius: 50% 20px; position: relative; display: flex; align-items: center; justify-content: center; background: rgba(5,5,5,0.75); backdrop-filter: blur(12px); overflow: hidden; }
    .arched-header::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background: linear-gradient(90deg, transparent, rgba(255,215,0,0.2), transparent); animation: sweep 4s ease-in-out infinite; }
    @keyframes sweep {0%{left:-100%;}50%{left:100%;}100%{left:-100%;}}
    .animated-text { background: linear-gradient(to right, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C); background-size:200% auto; -webkit-background-clip:text; color:transparent; animation: gradient-move 4s linear infinite; filter: drop-shadow(0 0 12px rgba(255,215,0,0.6)); }
    .logo-spin { animation: spin-y 8s linear infinite, twinkling 3s ease-in-out infinite; transform-style: preserve-3d; filter: drop-shadow(0 0 10px rgba(255,215,0,0.4)); }
    @keyframes spin-y { from {transform: rotateY(0);} to {transform: rotateY(360deg);} }

    .vertical-line { position: fixed; left: 50%; top: 80px; width: 2px; height: 40px; background: linear-gradient(180deg, rgba(255,215,0,0.3), rgba(220,20,60,0.2)); transform: translateX(-50%); z-index: 15; box-shadow: 0 0 10px rgba(255,215,0,0.2); }

    /* Layout */
    main { max-width: 1200px; margin: 0 auto; padding: 125px 1.25rem 200px; position: relative; z-index: 10; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.25rem; }
    .image-card { position: relative; border-radius: 12px; overflow: hidden; cursor: pointer; border: 1px solid rgba(255,215,0,0.2); box-shadow: 0 0 15px rgba(255,215,0,0.1); opacity: 0; transform: translateY(-20px); animation: slideInFromTop 0.5s ease-out forwards; }
    .image-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .image-card .wm { position: absolute; bottom: 0; left: 0; right: 0; height: 40px; background: rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; font-size: 12px; color: #FFD700; font-family: 'Orbitron', sans-serif; }

    /* Footer input */
    .fixed-footer { position: fixed; bottom: 0; left: 0; right: 0; z-index: 20; padding: 1rem; background: linear-gradient(180deg, rgba(10,10,10,0), rgba(10,10,10,0.8)); }
    .prompt-box-container { position: relative; width: 100%; }
    .prompt-box { width: 100%; border-radius: 12px; padding: 1rem; padding-left: 1rem; padding-right: 3rem; resize: none; min-height: 110px; color: white; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,215,0,0.2); box-shadow: inset 0 2px 4px rgba(255,255,255,0.05), 0 4px 12px rgba(0,0,0,0.3), 0 0 15px rgba(255,215,0,0.15); outline: none; }
    .prompt-box:focus { box-shadow: inset 0 2px 4px rgba(255,255,255,0.08), 0 6px 20px rgba(255,215,0,0.25), 0 0 25px rgba(220,20,60,0.15); }
    .mic-btn { position: absolute; bottom: 14px; left: 12px; width: 28px; height: 28px; border-radius: 50%; background: linear-gradient(145deg, rgba(255,215,0,0.2), rgba(220,20,60,0.1)); border: 1px solid rgba(255,215,0,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 0 10px rgba(255,215,0,0.2); }
    .mic-btn.recording::after { content: ''; position: absolute; width: 120%; height: 120%; border-radius: 50%; border: 1px solid rgba(220,20,60,0.3); animation: pulse-red 1.5s infinite; }
    @keyframes pulse-red {0%{transform:scale(1); box-shadow:0 0 0 0 rgba(220,20,60,0.4);}70%{transform:scale(1.1); box-shadow:0 0 0 10px rgba(220,20,60,0);}100%{transform:scale(1); box-shadow:0 0 0 0 rgba(220,20,60,0);}}
    .generate-btn { min-width: 140px; padding: 0.9rem 1.2rem; border-radius: 0 0 40px 40px; border: 1.5px solid rgba(255,215,0,0.4); background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(220,20,60,0.1)); color: #FFD700; font-weight: 700; letter-spacing: 2px; cursor: pointer; box-shadow: 0 8px 16px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.15), inset 0 -2px 0 rgba(0,0,0,0.3), 0 0 20px rgba(255,215,0,0.2), 0 0 40px rgba(220,20,60,0.1); transition: all 0.3s ease; }
    .generate-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .generate-btn:hover:enabled { background: linear-gradient(135deg, rgba(255,215,0,0.25), rgba(220,20,60,0.15)); box-shadow: 0 12px 24px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.2), inset 0 -2px 0 rgba(0,0,0,0.4), 0 0 30px rgba(255,215,0,0.4), 0 0 60px rgba(220,20,60,0.2); transform: translateY(-2px); }

    /* Buttons */
    .tab-btn { width: 50%; height: 40px; font-weight: 600; color: #FFD700; cursor: pointer; }
    .tab-wrap { width: 95%; max-width: 400px; display: flex; position: relative; }

    /* Footer link */
    .footer-link { background: linear-gradient(45deg, #000000 0%, #4a4a4a 20%, #ffffff 50%, #4a4a4a 80%, #000000 100%); -webkit-background-clip: text; color: transparent; filter: drop-shadow(0 0 1px rgba(255,255,255,0.2)); text-decoration: none; }

    /* Modals */
    .modal { width: 100%; max-width: 360px; background: rgba(255,255,255,0.08); backdrop-filter: blur(10px); border: 1px solid rgba(255,215,0,0.3); border-radius: 14px; padding: 1.25rem; color: #f5f5f5; }
    .settings-modal { max-width: 520px; }

    /* Slideshow */
    .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 50; display: flex; align-items: center; justify-content: center; }
    .lightbox img { max-width: 90vw; max-height: 80vh; border-radius: 12px; box-shadow: 0 0 50px rgba(255,215,0,0.2); }

    /* Snow canvas above content */
    #snowCanvas { position: fixed; inset: 0; pointer-events: none; z-index: 50; opacity: 0.95; }
    /* 3D background canvas behind */
    #bgCanvas { position: fixed; inset: 0; pointer-events: none; z-index: -1; }
  </style>
</head>
<body>
  <canvas id="bgCanvas"></canvas>
  <div class="vertical-line"></div>

  <div class="header-container">
    <header class="arched-header glass glass-border">
      <div class="font-brand text-xl sm:text-2xl font-bold tracking-wider">
        <span class="animated-text">üéÑ SHICOPIC üéÑ</span>
      </div>
    </header>
    <div class="tab-wrap">
      <button class="tab-btn glass glass-border" id="styleBtn">‚ú® Style</button>
      <button class="tab-btn glass glass-border" id="setupBtn">‚öôÔ∏è Setup</button>
    </div>
    <div style="position:absolute; top:50px; left:50%; transform:translateX(-50%); perspective:1000px; z-index:21;">
      <img src="https://raw.githubusercontent.com/Shervinuri/Shervinuri.github.io/refs/heads/main/1712259501956.png" alt="Logo" class="logo-spin" style="width:48px; height:48px; border-radius:50%;">
    </div>
  </div>

  <main>
    <div id="cards" class="grid"></div>
  </main>

  <div class="fixed-footer">
    <div style="max-width:1200px; margin:0 auto; display:flex; flex-direction:column; gap:0.75rem;">
      <div style="display:flex; flex-direction:column; gap:0.75rem;">
        <div class="prompt-box-container">
          <textarea id="prompt" class="prompt-box" placeholder="‚ú® ÿß€åÿØŸá‚Äåÿßÿ™ ÿ±ÿß ÿ®ŸÜŸà€åÿ≥ €åÿß ÿ®⁄ØŸà..."></textarea>
          <div id="micBtn" class="mic-btn" title="Voice"></div>
        </div>
        <button id="genBtn" class="generate-btn">üéÑ GŒû–òŒûRATŒû</button>
      </div>
      <div style="text-align:center; padding:0.5rem 0; border-top:1px solid rgba(255,215,0,0.3);">
        <a class="footer-link" href="https://t.me/shervini" target="_blank" rel="noopener noreferrer">Exclusive SHŒûN‚Ñ¢ made</a>
      </div>
    </div>
  </div>

  <!-- Style Modal -->
  <div id="styleModal" class="modal-backdrop hidden">
    <div class="modal">
      <h3 style="text-align:center; color:#FFD700; margin-top:0;">‚ú® ÿßŸÜÿ™ÿÆÿßÿ® ÿßÿ≥ÿ™ÿß€åŸÑ</h3>
      <div id="styleList" style="max-height:260px; overflow-y:auto; display:flex; flex-direction:column; gap:0.5rem;"></div>
      <div style="margin-top:1rem; display:flex; gap:0.5rem;">
        <button id="styleNone" class="glass glass-border" style="flex:1; padding:0.6rem; color:#e5e5e5;">ÿ®ÿØŸàŸÜ ÿßÿ≥ÿ™ÿß€åŸÑ</button>
        <button id="styleClose" class="glass glass-border" style="flex:1; padding:0.6rem; color:#e5e5e5;">ÿ®ÿ≥ÿ™ŸÜ</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-backdrop hidden">
    <div class="modal settings-modal">
      <h3 style="color:#FFD700; margin-top:0;">‚öôÔ∏è ÿ™ŸÜÿ∏€åŸÖÿßÿ™</h3>
      <div style="display:flex; flex-direction:column; gap:0.75rem;">
        <label style="display:flex; justify-content:space-between; align-items:center; color:#FFD700;">ŸÖÿØŸÑ
          <select id="modelSelect" class="glass glass-border" style="width:180px; background:transparent; color:#FFD700; padding:0.4rem;">
            <option value="flux">SHüéÑN‚Ñ¢ PRO (Flux)</option>
            <option value="dall-e-3">SHüéÑN‚Ñ¢ Alpha</option>
            <option value="midjourney">SHüéÑN‚Ñ¢ Julietta</option>
          </select>
        </label>
        <div style="display:flex; gap:0.35rem; justify-content:flex-end;">
          <button data-ar="1:1" class="glass glass-border" style="padding:0.4rem 0.7rem; color:#FFD700;">1:1</button>
          <button data-ar="16:9" class="glass glass-border" style="padding:0.4rem 0.7rem; color:#FFD700;">16:9</button>
          <button data-ar="9:16" class="glass glass-border" style="padding:0.4rem 0.7rem; color:#FFD700;">9:16</button>
        </div>
        <label style="display:flex; justify-content:space-between; align-items:center; color:#FFD700;">ÿπÿ±ÿ∂
          <input id="wInput" type="number" class="glass glass-border" style="width:90px; background:transparent; color:#FFD700; padding:0.35rem;" value="1024" />
        </label>
        <label style="display:flex; justify-content:space-between; align-items:center; color:#FFD700;">ÿßÿ±ÿ™ŸÅÿßÿπ
          <input id="hInput" type="number" class="glass glass-border" style="width:90px; background:transparent; color:#FFD700; padding:0.35rem;" value="1024" />
        </label>
        <div style="height:1px; background:rgba(255,215,0,0.2);"></div>
        <label style="display:flex; justify-content:space-between; align-items:center; color:#FFD700;">ÿ®Ÿáÿ®ŸàÿØ Prompt
          <input id="enhanceChk" type="checkbox" checked />
        </label>
        <label style="display:flex; justify-content:space-between; align-items:center; color:#FFD700;">üé≤ Seed ÿ™ÿµÿßÿØŸÅ€å
          <input id="randSeedChk" type="checkbox" checked />
        </label>
        <label style="display:flex; justify-content:space-between; align-items:center; color:#FFD700;">ÿßŸÅ⁄©ÿ™ ÿµÿØÿß
          <input id="soundChk" type="checkbox" checked />
        </label>
        <label style="display:flex; justify-content:space-between; align-items:center; color:#FFD700;">ÿ®ÿ±ŸÅ
          <input id="snowChk" type="checkbox" checked />
        </label>
      </div>
      <div style="text-align:right; margin-top:1rem;">
        <button id="settingsClose" class="glass glass-border" style="padding:0.6rem 1rem; color:black; background:linear-gradient(90deg,#FFD700,#DAA520);">ÿ∞ÿÆ€åÿ±Ÿá</button>
      </div>
    </div>
  </div>

  <!-- Slideshow -->
  <div id="lightbox" class="lightbox hidden">
    <button id="closeLightbox" style="position:absolute; top:20px; left:20px; font-size:26px; color:#FFD700; background:none; border:none; cursor:pointer;">‚úï</button>
    <button id="prevSlide" style="position:absolute; right:20px; top:50%; transform:translateY(-50%); font-size:32px; color:#FFD700; background:none; border:none; cursor:pointer;">‚Äπ</button>
    <button id="nextSlide" style="position:absolute; left:20px; top:50%; transform:translateY(-50%); font-size:32px; color:#FFD700; background:none; border:none; cursor:pointer;">‚Ä∫</button>
    <button id="dlSlide" style="position:absolute; top:20px; right:20px; font-size:24px; color:#FFD700; background:none; border:1px solid rgba(255,215,0,0.5); border-radius:50%; width:44px; height:44px; cursor:pointer;">‚¨á</button>
    <img id="lightboxImg" src="" alt="Generated" />
  </div>

  <!-- Snow overlay -->
  <canvas id="snowCanvas"></canvas>

  <!-- External libs -->
  <script src="https://unpkg.com/three@0.161.0/build/three.min.js"></script>

  <script>
    // ---- CONFIG & STATE ----
    const STYLES = [
      { name: 'Cinematic', suffix: ', cinematic shot, imax, christmas atmosphere, magical lighting, highly detailed' },
      { name: 'Realistic', suffix: ', hyperrealistic, 8k, winter photography, sharp focus' },
      { name: 'Photography', suffix: ', hyperrealistic professional ultra intricately detailed photography' },
      { name: 'Fantasy', suffix: ', epic fantasy, vibrant colors, surreal composition, masterpiece' },
      { name: 'Anime', suffix: ', anime art style, cel shading, vibrant colors, detailed character design, beautiful anime scenery' },
      { name: 'Artistic', suffix: ', digital art, concept art, artistic illustration, creative composition' },
      { name: 'Portrait', suffix: ', professional portrait photography, studio lighting, shallow depth of field' },
      { name: 'Landscape', suffix: ', landscape photography, golden hour lighting, dramatic sky, natural beauty' },
    ];
    const state = {
      prompt: '',
      isGenerating: false,
      images: [],
      activeStyle: null,
      showSnow: true,
      settings: {
        model: 'flux',
        width: 1024,
        height: 1024,
        enhance: true,
        seed: 42,
        randomSeed: true,
        soundEnabled: true,
      },
      slideshowIndex: null,
    };
    let recognition = null;

    // ---- DOM refs ----
    const promptEl = document.getElementById('prompt');
    const genBtn = document.getElementById('genBtn');
    const cardsEl = document.getElementById('cards');
    const styleModal = document.getElementById('styleModal');
    const settingsModal = document.getElementById('settingsModal');
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightboxImg');

    // ---- Style modal render ----
    const styleList = document.getElementById('styleList');
    STYLES.forEach((s, idx) => {
      const btn = document.createElement('button');
      btn.className = 'glass glass-border';
      btn.style.cssText = 'width:100%; padding:0.7rem; color:#e5e5e5; border-radius:10px; text-align:center;';
      btn.textContent = s.name;
      btn.onclick = () => { state.activeStyle = s; closeStyle(); };
      styleList.appendChild(btn);
    });

    // ---- Mic (speech) ----
    const micBtn = document.getElementById('micBtn');
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.continuous = false;
      recognition.lang = 'fa-IR';
      recognition.onresult = (e) => {
        const t = e.results[0][0].transcript;
        promptEl.value = (promptEl.value + ' ' + t).trim();
        micBtn.classList.remove('recording');
      };
      recognition.onerror = () => micBtn.classList.remove('recording');
      recognition.onend = () => micBtn.classList.remove('recording');
      micBtn.onclick = () => {
        if (micBtn.classList.contains('recording')) {
          recognition.stop();
        } else {
          micBtn.classList.add('recording');
          recognition.start();
        }
      };
    } else {
      micBtn.style.display = 'none';
    }

    // ---- Settings bindings ----
    document.getElementById('styleBtn').onclick = () => styleModal.classList.remove('hidden');
    document.getElementById('setupBtn').onclick = () => settingsModal.classList.remove('hidden');
    document.getElementById('styleClose').onclick = () => closeStyle();
    document.getElementById('styleNone').onclick = () => { state.activeStyle = null; closeStyle(); };
    function closeStyle(){ styleModal.classList.add('hidden'); }

    document.getElementById('settingsClose').onclick = () => settingsModal.classList.add('hidden');
    document.getElementById('modelSelect').onchange = (e)=> state.settings.model = e.target.value;
    document.getElementById('wInput').onchange = (e)=> state.settings.width = Number(e.target.value)||1024;
    document.getElementById('hInput').onchange = (e)=> state.settings.height = Number(e.target.value)||1024;
    document.getElementById('enhanceChk').onchange = (e)=> state.settings.enhance = e.target.checked;
    document.getElementById('randSeedChk').onchange = (e)=> state.settings.randomSeed = e.target.checked;
    document.getElementById('soundChk').onchange = (e)=> state.settings.soundEnabled = e.target.checked;
    document.getElementById('snowChk').onchange = (e)=> { state.showSnow = e.target.checked; document.getElementById('snowCanvas').style.display = state.showSnow ? 'block':'none'; };
    document.querySelectorAll('[data-ar]').forEach(btn=>{
      btn.onclick=()=>{
        const ar = btn.dataset.ar;
        if(ar==='1:1'){state.settings.width=1024; state.settings.height=1024;}
        if(ar==='16:9'){state.settings.width=1280; state.settings.height=720;}
        if(ar==='9:16'){state.settings.width=720; state.settings.height=1280;}
        document.getElementById('wInput').value = state.settings.width;
        document.getElementById('hInput').value = state.settings.height;
      };
    });

    // ---- Generate handler ----
    genBtn.onclick = async () => {
      if (state.isGenerating) return;
      const prompt = promptEl.value.trim();
      if (!prompt) return;
      state.isGenerating = true; genBtn.disabled = true;

      const seed = state.settings.randomSeed ? Math.floor(Math.random()*1e6) : state.settings.seed;
      let finalPrompt = prompt + (state.activeStyle ? state.activeStyle.suffix : '');

      // Optional: simple enhance via Pollinations text endpoint (best-effort)
      if (state.settings.enhance) {
        try {
          const resp = await fetch('https://text.pollinations.ai/openai', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
              model:'openai',
              messages:[{role:'system',content:'Rewrite to an English, detailed, photorealistic image prompt with Christmas flavor if relevant.'},{role:'user',content:finalPrompt}]
            })
          });
          if (resp.ok) {
            const txt = await resp.text();
            try { finalPrompt = JSON.parse(txt).choices?.[0]?.message?.content || txt; }
            catch { finalPrompt = txt; }
          }
        } catch {}
      }

      const base = encodeURIComponent(finalPrompt);
      const model = encodeURIComponent(state.settings.model);
      const url = `https://image.pollinations.ai/prompt/${base}?model=${model}&width=${state.settings.width}&height=${state.settings.height}&seed=${seed}&nologo=true&safe=false`;

      // Play start sound
      if (state.settings.soundEnabled) {
        const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3');
        audio.volume = 0.2; audio.play().catch(()=>{});
      }

      try {
        const resp = await fetch(url);
        if(!resp.ok) throw new Error('fetch failed');
        const blob = await resp.blob();
        const objUrl = URL.createObjectURL(blob);
        state.images.unshift({ url: objUrl, prompt: finalPrompt, ts: Date.now() });
        renderCards();
        // success sound
        if (state.settings.soundEnabled) {
          const audio2 = new Audio('https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3');
          audio2.volume = 0.4; audio2.play().catch(()=>{});
        }
      } catch (e) {
        alert('ÿÆÿ∑ÿß ÿØÿ± ÿßÿ™ÿµÿßŸÑ €åÿß ÿ™ŸàŸÑ€åÿØ ÿ™ÿµŸà€åÿ±');
        console.error(e);
      } finally {
        state.isGenerating = false; genBtn.disabled = false;
      }
    };

    // ---- Render cards ----
    function renderCards(){
      cardsEl.innerHTML = '';
      state.images.forEach((img, idx)=>{
        const card = document.createElement('div');
        card.className = 'image-card glass glass-border';
        const image = document.createElement('img'); image.src = img.url;
        const wm = document.createElement('div'); wm.className='wm'; wm.textContent='‚ú® Exclusive ‚ò¨SHŒûN‚Ñ¢ Made ‚ú®';
        const dl = document.createElement('button');
        dl.textContent='‚¨á'; dl.title='Download';
        dl.style.cssText='position:absolute; top:8px; left:8px; background:rgba(255,215,0,0.4); border:1px solid rgba(255,215,0,0.6); border-radius:50%; width:34px; height:34px; cursor:pointer; color:white;';
        dl.onclick = (ev)=>{ ev.stopPropagation(); const a=document.createElement('a'); a.href=img.url; a.download='shen_gen.png'; a.click(); };
        card.onclick = ()=> openLightbox(idx);
        card.appendChild(image); card.appendChild(wm); card.appendChild(dl);
        cardsEl.appendChild(card);
      });
    }

    // ---- Lightbox ----
    function openLightbox(i){ state.slideshowIndex = i; updateLightbox(); lightbox.classList.remove('hidden'); }
    function closeLightbox(){ lightbox.classList.add('hidden'); }
    function updateLightbox(){
      if(state.slideshowIndex==null) return;
      const img = state.images[state.slideshowIndex];
      if(img) lightboxImg.src = img.url;
    }
    document.getElementById('closeLightbox').onclick = closeLightbox;
    document.getElementById('nextSlide').onclick = ()=>{ if(!state.images.length) return; state.slideshowIndex = (state.slideshowIndex+1)%state.images.length; updateLightbox(); };
    document.getElementById('prevSlide').onclick = ()=>{ if(!state.images.length) return; state.slideshowIndex = (state.slideshowIndex-1+state.images.length)%state.images.length; updateLightbox(); };
    document.getElementById('dlSlide').onclick = ()=>{ if(state.slideshowIndex==null) return; const img=state.images[state.slideshowIndex]; const a=document.createElement('a'); a.href=img.url; a.download='shen_gen.png'; a.click(); };

    // ---- Three.js starfield ----
    (function initThree(){
      const canvas = document.getElementById('bgCanvas');
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ canvas, alpha:true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      const count = 2500;
      const positions = new Float32Array(count*3);
      for(let i=0;i<count*3;i++) positions[i]=(Math.random()-0.5)*30;
      const geometry = new THREE.BufferGeometry();
      geometry.setAttribute('position', new THREE.BufferAttribute(positions,3));
      const material = new THREE.PointsMaterial({ color:0xFFD700, size:0.03, transparent:true, blending:THREE.AdditiveBlending });
      const particles = new THREE.Points(geometry, material);
      scene.add(particles);
      camera.position.z = 8;
      function animate(){
        requestAnimationFrame(animate);
        particles.rotation.y += 0.0008;
        particles.rotation.x += 0.0004;
        renderer.render(scene,camera);
      }
      animate();
      window.addEventListener('resize', ()=>{
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    })();

    // ---- Snow overlay ----
    (function initSnow(){
      const canvas = document.getElementById('snowCanvas');
      const ctx = canvas.getContext('2d');
      let w=window.innerWidth, h=window.innerHeight;
      canvas.width=w; canvas.height=h;
      const spriteSize=32;
      const sprite=document.createElement('canvas');
      sprite.width=spriteSize; sprite.height=spriteSize;
      const sCtx=sprite.getContext('2d');
      if(sCtx){
        sCtx.strokeStyle='rgba(255,255,255,0.95)';
        sCtx.lineWidth=2.2; sCtx.lineCap='round'; sCtx.shadowBlur=4; sCtx.shadowColor='rgba(255,255,255,0.9)';
        const cx=spriteSize/2, cy=spriteSize/2, r=spriteSize/2-4;
        for(let i=0;i<6;i++){
          sCtx.save(); sCtx.translate(cx,cy); sCtx.rotate((Math.PI/3)*i);
          sCtx.beginPath(); sCtx.moveTo(0,0); sCtx.lineTo(0,-r); sCtx.stroke();
          sCtx.beginPath(); sCtx.moveTo(0,-r*0.6); sCtx.lineTo(r*0.25,-r*0.45); sCtx.moveTo(0,-r*0.6); sCtx.lineTo(-r*0.25,-r*0.45); sCtx.stroke();
          sCtx.beginPath(); sCtx.moveTo(0,-r*0.3); sCtx.lineTo(r*0.15,-r*0.2); sCtx.moveTo(0,-r*0.3); sCtx.lineTo(-r*0.15,-r*0.2); sCtx.stroke();
          sCtx.restore();
        }
      }
      const count = w<768 ? 150 : 400;
      const parts=[];
      function make(randomY=true){
        return {
          x: Math.random()*w,
          y: randomY ? Math.random()*h : -20,
          r: Math.random()*0.3+0.2,
          vy: Math.random()*1.5+1,
          vx: Math.random()*1-0.5,
          alpha: Math.random()*0.3+0.7,
          melt: Math.random()*0.003+0.0005,
          sway: Math.random()*100,
          rot: Math.random()*Math.PI*2,
          rs: (Math.random()-0.5)*0.05,
          landed:false,
        };
      }
      for(let i=0;i<count;i++) parts.push(make(true));
      function tick(){
        if(!state.showSnow){ ctx.clearRect(0,0,w,h); requestAnimationFrame(tick); return; }
        ctx.clearRect(0,0,w,h);
        for(let i=0;i<count;i++){
          const p=parts[i];
          if(p.landed){
            p.alpha-=p.melt;
            ctx.beginPath(); ctx.fillStyle=`rgba(255,255,255,${p.alpha})`; ctx.ellipse(p.x,p.y,p.r*10,p.r*6,0,0,Math.PI*2); ctx.fill();
            if(p.alpha<=0) parts[i]=make(false);
            continue;
          }
          p.x += Math.sin(p.sway + p.y*0.01)*0.5 + p.vx;
          p.y += p.vy;
          p.rot += p.rs;
          if(p.y > h){ parts[i]=make(false); continue; }
          if(p.x > w+10) p.x=-10; if(p.x < -10) p.x=w+10;
          ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.scale(p.r,p.r); ctx.globalAlpha=p.alpha; ctx.drawImage(sprite,-spriteSize/2,-spriteSize/2); ctx.restore();
        }
        requestAnimationFrame(tick);
      }
      tick();
      window.addEventListener('resize', ()=>{ w=window.innerWidth; h=window.innerHeight; canvas.width=w; canvas.height=h; });
    })();
  </script>
</body>
</html>
